stages:
  - build
  - deploy

variables:
  IMAGE: "${DOCKER_IMAGE}:${CI_COMMIT_SHORT_SHA}"

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""

  before_script:
    - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USER" --password-stdin
  script:
    - docker build -t "$IMAGE" .
    - docker push "$IMAGE"
    - docker tag "$IMAGE" "${DOCKER_IMAGE}:latest" || true
    - docker push "${DOCKER_IMAGE}:latest" || true
  only:
    - staging
  tags:
    - linux
    - vm

deploy:
  stage: deploy
  image: docker/compose:latest
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script:
    - echo "Desplegando en VM v√≠a runner shell"
    - docker pull "$IMAGE" || true
    - cd /deploy-dir || exit 1
    - "sed -i 's|image: .*|image: ${IMAGE}|g' docker-compose.yaml || true"
    - docker network create tall || true 
    - docker-compose -f docker-compose.yaml up -d --remove-orphans
    - docker image prune -f
  only:
    - staging
  tags:
    - linux
    - vm
  dependencies:
    - build
